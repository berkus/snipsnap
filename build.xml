<?xml version="1.0" encoding="UTF-8"?>
<!--
  ** @author Matthias L. Jugel
  ** @version $Id$
  -->
<project basedir="." default="all" name="solent sources">

  <property file="conf/build.properties"/>
  <property file="conf/snipsnap.conf"/>

  <path id="server.classpath">
    <pathelement location="${jar}/javax.servlet.jar"/>
    <pathelement location="${jar}/org.apache.jasper.jar"/>
    <pathelement location="${jar}/org.apache.crimson.jar"/>
    <pathelement location="${jar}/org.mortbay.jetty.jar"/>
  </path>

  <!-- the overall class path -->
  <path id="app.classpath">
    <pathelement location="${jar}/jdbcpool.jar"/>
    <pathelement location="${jar}/jakarta.jar"/>
    <pathelement location="${jar}/mckoidb.jar"/>
    <pathelement location="${jar}/xmlrpc-1.1.jar"/>
    <pathelement location="${jar}/lucene-1.2.jar"/>
    <pathelement location="${jar}/jython.jar"/>
    <pathelement location="${jar}/muse-jabber-0.8a1.jar"/>
    <pathelement location="${jar}/aspectjrt.jar"/>
    <pathelement location="${jar}/jdom-b8.jar"/>
    <pathelement location="${src}/apps/default/WEB-INF/lib/jstl.jar"/>
    <pathelement location="${src}/apps/default/WEB-INF/lib/standard.jar"/>
  </path>

  <path id="all.classpath">
    <path refid="server.classpath"/>
    <path refid="app.classpath"/>
  </path>

  <!-- build distribution -->
  <target depends="tar-source, tar-binary" name="dist" description="tar complete distribution"/>

  <!-- build binary distribution package -->
  <target depends="clean" description="tar source package" name="tar-source">
    <tstamp/>
    <tar destfile="../${appname}-${server.version}-${DSTAMP}-src.tgz" compression="gzip">
      <tarfileset dir="." prefix="${appname}-${server.version}" mode="700">
        <include name="run.sh"/>
        <include name="run.bat"/>
        <include name="db.sh"/>
        <include name="dbexport.sh"/>
        <include name="dbimport.sh"/>
        <include name="dbrepair.sh"/>
        <include name="exportall.sh"/>
      </tarfileset>
      <tarfileset dir="." prefix="${appname}-${server.version}">
        <include name="**"/>
        <exclude name="**/CVS"/>
        <exclude name="applications"/>
        <exclude name="run.sh"/>
        <exclude name="run.bat"/>
        <exclude name="db.sh"/>
        <exclude name="dbexport.sh"/>
        <exclude name="dbimport.sh"/>
        <exclude name="dbrepair.sh"/>
        <exclude name="exportall.sh"/>
        <exclude name="src/theme/drrockit/"/>
        <exclude name="src/theme/javangelist/"/>
        <exclude name="src/theme/sib/"/>
      </tarfileset>
    </tar>
  </target>

  <target depends="clean, all" description="tar binary package" name="tar-binary">
    <tstamp/>
    <tar destfile="../${appname}-${server.version}-${DSTAMP}.tgz" compression="gzip">
      <tarfileset dir="." prefix="${appname}-${server.version}" mode="700">
        <include name="run.sh"/>
        <include name="run.bat"/>
        <include name="db.sh"/>
        <include name="dbexport.sh"/>
        <include name="dbimport.sh"/>
        <include name="dbrepair.sh"/>
        <include name="exportall.sh"/>
      </tarfileset>
      <tarfileset dir="." prefix="${appname}-${server.version}">
        <include name="${jar}/${appname}.jar"/>
        <include name="${jar}/javax.servlet.jar"/>
        <include name="${jar}/org.apache.jasper.jar"/>
        <include name="${jar}/org.apache.crimson.jar"/>
        <include name="${jar}/org.mortbay.jetty.jar"/>
        <include name="${jar}/mckoidb.jar"/>
        <include name="${jar}/jdbcpool.jar"/>
        <include name="${jar}/lucene-1.2.jar"/>
        <include name="${jar}/${appname}-template.war"/>
        <include name="${jar}/${appname}-theme-*.jar"/>
        <include name="${jar}/${appname}-installer.war"/>
        <include name="${jar}/${appname}-utils.jar"/>
        <include name="conf/snipsnap.conf"/>
        <include name="conf/db.conf"/>
        <include name="conf/jetty.conf"/>
        <include name="conf/romaji.properties"/>
        <include name="conf/intermap.txt"/>
        <include name="conf/bookservices.txt"/>
        <include name="conf/snipsnap.snip"/>
        <include name="license.txt"/>
        <include name="validate.xsl"/>
        <include name="README"/>
        <exclude name="**/CVS"/>
        <exclude name="run.sh"/>
        <exclude name="run.bat"/>
        <exclude name="db.sh"/>
        <exclude name="dbexport.sh"/>
        <exclude name="dbimport.sh"/>
        <exclude name="dbrepair.sh"/>
        <exclude name="exportall.sh"/>
      </tarfileset>
    </tar>
  </target>

  <!-- delete compiled class files and created jar/war archives -->
  <target description="clean up compiled code" name="clean">
    <delete>
      <fileset dir="${target}" includes="**" excludes="CVS"/>
    </delete>
    <delete>
      <fileset dir="${jar}" includes="${appname}*.jar"/>
      <fileset dir="${jar}" includes="${appname}*.war"/>
      <fileset dir="${src}/apps/default/WEB-INF/lib" includes="${appname}-servlets.jar"/>
    </delete>
  </target>

  <!-- create all archives -->
  <target depends="jar-server,jar-util,template-war" description="create all" name="all"/>

  <!-- create server code -->
  <target depends="compile-server,installer-war" description="create server jar" name="jar-server">
    <jar destfile="${jar}/${appname}.jar" excludes="**/CVS" manifest="conf/manifest">
      <fileset dir="${target}/server" includes="**"/>
    </jar>
  </target>

  <target description="compile server code" name="compile-server">
    <mkdir dir="${target}/server"/>
    <javac deprecation="${deprecation}" debug="${debug}"
      srcdir="${src}"
      destdir="${target}/server"
      classpathref="server.classpath"
      includes="org/snipsnap/server/**"/>
  </target>

  <!-- create utility code -->
  <target depends="compile-util" description="build util jar" name="jar-util">
    <jar destfile="${jar}/${appname}-utils.jar" excludes="**/CVS">
      <fileset dir="${target}/util" includes="**"/>
    </jar>
  </target>

  <target description="compile util code" name="compile-util">
    <mkdir dir="${target}/util"/>
    <javac deprecation="${deprecation}" debug="${debug}"
      srcdir="${src}"
      classpathref="all.classpath"
      destdir="${target}/util"
      includes="org/snipsnap/util/Test*, org/snipsnap/util/*Util.java, org/snipsnap/util/DB*.java, org/snipsnap/util/*JDBC*.java"/>
  </target>

  <!-- create web archive of the template application -->
  <target depends="compile-app,theme-jar" description="build template war" name="template-war">
    <jar destfile="${src}/apps/default/WEB-INF/lib/snipsnap-servlets.jar" excludes="**/CVS">
      <fileset dir="${target}/default/WEB-INF/classes" includes="**"/>
      <fileset dir="${src}" includes="META-INF/**"/>
    </jar>

    <jar destfile="${jar}/${appname}-template.war" excludes="**/CVS">
      <fileset dir="${src}/apps/default" includes="**"/>
      <fileset dir="${src}/theme/blue" includes="**"/>
      <zipfileset dir="${jar}" prefix="WEB-INF/lib">
        <include name="mckoidb.jar"/>
        <include name="jdbcpool.jar"/>
        <include name="jakarta.jar"/>
        <include name="lucene-1.2.jar"/>
        <include name="xmlrpc-1.1.jar"/>
        <include name="muse-jabber-0.8a1.jar"/>
        <include name="jdom-b8.jar"/>
        <include name="aspectjrt.jar"/>
        <include name="jython.jar"/>
      </zipfileset>
    </jar>
  </target>

  <!-- create jar archives of all themes -->
  <target description="build theme jar" name="theme-jar">
    <jar destfile="${jar}/${appname}-theme-blue.jar" excludes="**/CVS">
      <fileset dir="${src}/theme/blue" includes="**"/>
      <fileset dir="${src}/theme" includes="blue.snip"/>
    </jar>
  </target>

  <target name="compile-jsp" description="compile jsp files">
    <!-- ignore for now ...
    <mkdir dir="${target}/jsp"/>
    <jspc destdir="${target}/jsp" verbose="1" srcdir="${src}/apps/default"
          package="org.snipsnap.jsp.pages" classpathref="all.classpath">
      <include name="**/*.jsp" />
      <webapp basedir="${src}/apps/default"/>
    </jspc>
    -->
  </target>

  <target depends="compile-jsp" description="compile template application code" name="compile-app">
    <mkdir dir="${target}/default/WEB-INF/classes"/>
    <javac deprecation="${deprecation}" debug="${debug}"
      srcdir="${src}"
      classpathref="all.classpath"
      destdir="${target}/default/WEB-INF/classes"
      excludes="org/snipsnap/test/**,org/snipsnap/admin/**, org/snipsnap/server/**">
      <src path="${src}"/>
      <src path="${target}/jsp"/>
      <include name="org/snipsnap/**"/>
    </javac>
  </target>

  <!-- create web archive of the installer web application -->
  <target depends="compile-installer" description="build installer war" name="installer-war">
    <jar destfile="${jar}/installer-servlets.jar" excludes="**/CVS">
      <fileset dir="${target}/installer/WEB-INF/classes" includes="**"/>
    </jar>
    <jar destfile="${jar}/${appname}-installer.war" excludes="**/CVS">
      <fileset dir="${src}/apps/installer" includes="**"/>
      <zipfileset dir="${jar}" prefix="WEB-INF/lib">
        <include name="mckoidb.jar"/>
        <include name="jdbcpool.jar"/>
        <include name="lucene-1.2.jar"/>
        <include name="xmlrpc-1.1.jar"/>
      </zipfileset>
      <zipfileset dir="${src}/apps/default">
        <include name="WEB-INF/c.tld"/>
        <include name="WEB-INF/lib/jstl.jar"/>
        <include name="WEB-INF/lib/standard.jar"/>
      </zipfileset>
    </jar>
  </target>

  <target description="compile installer application code" name="compile-installer">
    <mkdir dir="${target}/installer/WEB-INF/classes"/>
    <javac deprecation="${deprecation}" debug="${debug}"
      srcdir="${src}"
      classpathref="all.classpath"
      destdir="${target}/installer/WEB-INF/classes"
      includes="org/snipsnap/admin/CommandHandler.java, org/snipsnap/admin/Authenticate.java, org/snipsnap/admin/install/**"/>
  </target>

</project>


