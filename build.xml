<?xml version="1.0" encoding="UTF-8"?>
<!--
  ** @author Matthias L. Jugel
  ** @version $Id$
  -->
<project basedir="." default="jar" name="solent sources">

  <property file="conf/build.properties"/>
  <property file="conf/snipsnap.conf"/>

  <!-- the overall class path -->
  <path id="classpath">
    <pathelement location="${jar}/jdbcpool.jar"/>
    <pathelement location="${jar}/jakarta.jar"/>
    <pathelement location="${jar}/mckoidb.jar"/>
    <pathelement location="${jar}/javax.servlet.jar"/>
    <pathelement location="${jar}/org.apache.jasper.jar"/>
    <pathelement location="${jar}/org.apache.crimson.jar"/>
    <pathelement location="${jar}/org.mortbay.jetty.jar"/>
    <pathelement location="${jar}/xmlrpc-1.1.jar"/>
    <pathelement location="${jar}/lucene-1.2.jar"/>
    <pathelement location="${jar}/jython.jar"/>
    <pathelement location="${jar}/muse-jabber-0.8a1.jar"/>
    <pathelement location="${jar}/aspectjrt.jar"/>
    <pathelement location="${jar}/jdom-b8.jar"/>
    <pathelement location="${src}/apps/default/WEB-INF/lib/jstl.jar"/>
    <pathelement location="${src}/apps/default/WEB-INF/lib/standard.jar"/>
  </path>

  <!-- build binary distribution package -->
  <target depends="clean" description="build source package" name="src-tar">
    <tstamp/>
    <tar destfile="../${appname}-${server.version}-${DSTAMP}-src.tgz" compression="gzip">
      <tarfileset dir="." prefix="${appname}-${server.version}" mode="700">
        <include name="run.sh"/>
        <include name="run.bat"/>
        <include name="db.sh"/>
        <include name="dbexport.sh"/>
        <include name="dbimport.sh"/>
        <include name="dbrepair.sh"/>
        <include name="exportall.sh"/>
      </tarfileset>
      <tarfileset dir="." prefix="${appname}-${server.version}">
        <include name="**"/>
        <exclude name="**/CVS"/>
        <exclude name="applications"/>
        <exclude name="run.sh"/>
        <exclude name="run.bat"/>
        <exclude name="db.sh"/>
        <exclude name="dbexport.sh"/>
        <exclude name="dbimport.sh"/>
        <exclude name="dbrepair.sh"/>
        <exclude name="exportall.sh"/>
      </tarfileset>
    </tar>
  </target>

  <target depends="clean, jar" description="build binary package" name="bin-tar">
    <tstamp/>
    <tar destfile="../${appname}-${server.version}-${DSTAMP}.tgz" compression="gzip">
      <tarfileset dir="." prefix="${appname}-${server.version}" mode="700">
        <include name="run.sh"/>
        <include name="run.bat"/>
        <include name="db.sh"/>
        <include name="dbexport.sh"/>
        <include name="dbimport.sh"/>
        <include name="dbrepair.sh"/>
        <include name="exportall.sh"/>
      </tarfileset>
      <tarfileset dir="." prefix="${appname}-${server.version}">
        <include name="${jar}/${appname}.jar"/>
        <include name="${jar}/jdbcpool.jar"/>
        <include name="${jar}/jakarta.jar"/>
        <include name="${jar}/mckoidb.jar"/>
        <include name="${jar}/javax.servlet.jar"/>
        <include name="${jar}/org.apache.jasper.jar"/>
        <include name="${jar}/org.apache.crimson.jar"/>
        <include name="${jar}/org.mortbay.jetty.jar"/>
        <include name="${jar}/xmlrpc-1.1.jar"/>
        <include name="${jar}/lucene-1.2.jar"/>
        <include name="${jar}/jython.jar"/>
        <include name="${jar}/muse-jabber-0.8a1.jar"/>
        <include name="${jar}/aspectjrt.jar"/>
        <include name="${jar}/jdom-b8.jar"/>
        <include name="${jar}/${appname}-template.war"/>
        <include name="${jar}/${appname}-layout-*.jar"/>
        <include name="${jar}/${appname}-installer.war"/>
        <include name="${jar}/${appname}-utils.jar"/>
        <include name="conf/snipsnap.conf"/>
        <include name="conf/db.conf"/>
        <include name="conf/jetty.conf"/>
        <include name="conf/romaji.properties"/>
        <include name="conf/intermap.txt"/>
        <include name="conf/bookservices.txt"/>
        <include name="conf/snipsnap.snip"/>
        <include name="license.txt"/>
        <include name="validate.xsl"/>
        <include name="README"/>
        <exclude name="**/CVS"/>
        <exclude name="run.sh"/>
        <exclude name="run.bat"/>
        <exclude name="db.sh"/>
        <exclude name="dbexport.sh"/>
        <exclude name="dbimport.sh"/>
        <exclude name="dbrepair.sh"/>
        <exclude name="exportall.sh"/>
      </tarfileset>
    </tar>
  </target>

  <!-- delete compiled class files and created jar/war archives -->
  <target description="clean up compiled code" name="clean">
    <delete dir="${target}/server"/>
    <delete dir="${target}/util"/>
    <delete dir="${target}/installer"/>
    <delete dir="${target}/default"/>
    <delete>
      <fileset dir="${jar}" includes="${appname}.jar"/>
      <fileset dir="${jar}" includes="${appname}-utils.jar"/>
      <fileset dir="${jar}" includes="${appname}-installer.war"/>
      <fileset dir="${jar}" includes="${appname}-template.war"/>
      <fileset dir="${jar}" includes="${appname}-layout-*.jar"/>
    </delete>
  </target>

  <!-- create a jar containing the server code and compile all supporting applications  -->
  <target depends="build-server,util-jar,template-war,layout-jar,installer-war" description="build executable jar" name="jar">
    <jar destfile="${jar}/${appname}.jar" excludes="**/CVS" manifest="conf/manifest">
      <fileset dir="${target}/server" includes="**"/>
    </jar>
  </target>

  <!-- create a jar archive of the utility classes -->
  <target depends="build-util" description="build util war" name="util-jar">
    <jar destfile="${jar}/${appname}-utils.jar" excludes="**/CVS">
      <fileset dir="${target}/util" includes="**"/>
    </jar>
  </target>

  <!-- create web archive of the template application -->
  <target depends="build-template-app" description="build template war" name="template-war">
    <!-- TODO: Hack to allow running without a war -->
    <jar destfile="${src}/apps/default/WEB-INF/lib/servlets.jar" excludes="**/CVS">
      <fileset dir="${target}/default/WEB-INF/classes" includes="**"/>
    </jar>
    <jar destfile="${jar}/${appname}-template.war" excludes="**/CVS">
      <fileset dir="${src}/apps/default" includes="**">
        <exclude name="css/**"/>
        <exclude name="images/**"/>
      </fileset>
      <fileset dir="${src}/layout/snipsnap" includes="**"/>
    </jar>
  </target>

  <!-- create jar archives of all layouts -->
  <target description="build layout jar" name="layout-jar">
    <jar destfile="${jar}/${appname}-layout-blue.war" excludes="**/CVS">
      <fileset dir="${src}/layout/blue" includes="**"/>
      <fileset dir="${src}/layout" includes="blue.snip"/>
    </jar>
  </target>

  <!-- create web archive of the installer web application -->
  <target depends="build-installer-app" description="build installer war" name="installer-war">
    <mkdir dir="${src}/apps/installer/WEB-INF/lib"/>
    <jar destfile="${src}/apps/installer/WEB-INF/lib/servlets.jar" excludes="**/CVS">
      <fileset dir="${target}/installer/WEB-INF/classes" includes="**"/>
    </jar>
    <jar destfile="${jar}/${appname}-installer.war" excludes="**/CVS">
      <fileset dir="${src}/apps/installer" includes="**"/>
      <fileset dir="${src}/apps/default/" includes="WEB-INF/lib/jstl.jar, WEB-INF/lib/standard.jar"/>
    </jar>
  </target>

  <!-- shortcut for running the server code, deprecated: use run.sh -->
  <target depends="jar" description="run application server" name="run">
    <java classname="org.snipsnap.server.AppServer" fork="true"
      classpathref="classpath">
      <classpath path="${jar}/${appname}.jar">
        <pathelement location="${java.home}/lib/tools.jar"/>
      </classpath>
    </java>
  </target>

  <!-- a simple help target to build all applications and server code -->
  <target depends="build-server, build-util, build-template-app, build-installer-app"
    description="build all code" name="build"/>

  <target description="compile server code" name="build-server">
    <mkdir dir="${target}/server"/>
    <javac deprecation="${deprecation}" debug="${debug}"
      srcdir="${src}"
      classpathref="classpath"
      destdir="${target}/server"
      includes="org/snipsnap/server/**, org/snipsnap/util/*JDBC*"/>
  </target>

  <target description="compile util code" name="build-util">
    <mkdir dir="${target}/util"/>
    <javac deprecation="${deprecation}" debug="${debug}"
      srcdir="${src}"
      classpathref="classpath"
      destdir="${target}/util"
      includes="org/snipsnap/util/Test*, org/snipsnap/util/*Util.java, org/snipsnap/util/DB*.java, org/snipsnap/util/*JDBC*.java"/>
  </target>

  <target description="compile template application code" name="build-template-app">
    <mkdir dir="${target}/default/WEB-INF/classes"/>
    <javac deprecation="${deprecation}" debug="${debug}"
      srcdir="${src}"
      classpathref="classpath"
      destdir="${target}/default/WEB-INF/classes"
      includes="org/snipsnap/**"
      excludes="org/snipsnap/test/**,org/snipsnap/admin/**, org/snipsnap/server/**"/>
  </target>

  <target description="compile installer application code" name="build-installer-app">
    <mkdir dir="${target}/installer/WEB-INF/classes"/>
    <javac deprecation="${deprecation}" debug="${debug}"
      srcdir="${src}"
      classpathref="classpath"
      destdir="${target}/installer/WEB-INF/classes"
      includes="org/snipsnap/admin/CommandHandler.java, org/snipsnap/admin/Authenticate.java, org/snipsnap/admin/install/**"/>
  </target>

</project>


